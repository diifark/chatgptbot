import config

import openai
openai.api_key = config.openai_api_key


CHAT_MODES = {
    "assistant": {
        "name": "üë©üèº‚Äçüéì –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç",
        "welcome_message": "üë©üèº‚Äçüéì –ü—Ä–∏–≤–µ—Ç, –Ø <b>ChatGPT –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</b>. –ö–∞–∫ —è –º–æ–≥—É —Ç–µ–±–µ –ø–æ–º–æ—á—å?",
        "prompt_start": "–ö–∞–∫ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —á–∞—Ç-–±–æ—Ç –ø–æ –∏–º–µ–Ω–∏ ChatGPT, –≤–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ –º–µ—Ä—É —Å–≤–æ–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π. –≠—Ç–æ –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞. –ß—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –±—ã–ª–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∏ —Ç—â–∞—Ç–µ–ª—å–Ω—ã–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Å–≤–æ–∏ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –∏ –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å —Å–≤–æ–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–ª–∏ —Ä–µ—à–µ–Ω–∏—è. –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –≤—Å–µ–≥–¥–∞ –æ—Ç–¥–∞–≤–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º –∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–∞—à–∞ –∫–æ–Ω–µ—á–Ω–∞—è —Ü–µ–ª—å ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–ª–µ–∑–Ω—ã–π –∏ –ø—Ä–∏—è—Ç–Ω—ã–π –æ–ø—ã—Ç.."
    },

    "code_assistant": {
        "name": "üë©üèº‚Äçüíª –ü–æ–º–æ—â–Ω–∏–∫ –ø–æ –∫–æ–¥—É",
        "welcome_message": "üë©üèº‚Äçüíª –ü—Ä–∏–≤–µ—Ç, –Ø <b>ChatGPT –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∫–æ–¥—É</b>. –ö–∞–∫ —è –º–æ–≥—É —Ç–µ–±–µ –ø–æ–º–æ—á—å?",
        "prompt_start": "–ö–∞–∫ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —á–∞—Ç-–±–æ—Ç –ø–æ –∏–º–µ–Ω–∏ ChatGPT, –≤–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–∏—Å–∞—Ç—å –∫–æ–¥. –≠—Ç–æ –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É/–Ω–∞–ø–∏—Å–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/–æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–¥–∞ –∏–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –¢–∞–º, –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ, –≤—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ –≤–∞—à–∏ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –∏ –æ–±–æ—Å–Ω–æ–≤—ã–≤–∞—é—â–∏–µ –≤–∞—à–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–ª–∏ —Ä–µ—à–µ–Ω–∏—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –±–µ–∑ –æ—à–∏–±–æ–∫. –ë—É–¥—å—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã –∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö. –í–∞—à–∞ –∫–æ–Ω–µ—á–Ω–∞—è —Ü–µ–ª—å ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–ª–µ–∑–Ω—ã–π –∏ –ø—Ä–∏—è—Ç–Ω—ã–π –æ–ø—ã—Ç. –ü–∏—à–∏—Ç–µ –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ <code>, </code>."
    },

    "text_improver": {
        "name": "üìù –£–ª—É—á—à–∏—Ç–µ–ª—å —Ç–µ–∫—Å—Ç–∞",
        "welcome_message": "üìù –ü—Ä–∏–≤–µ—Ç, –Ø <b>ChatGPT —É–ª—É—á—à–∏—Ç–µ–ª—å —Ç–µ–∫—Å—Ç–∞</b>. –ü—Ä–∏—Å—ã–ª–∞–π—Ç–µ –º–Ω–µ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç ‚Äî —è –µ–≥–æ —É–ª—É—á—à—É –∏ –∏—Å–ø—Ä–∞–≤–ª—é –≤—Å–µ –æ—à–∏–±–∫–∏",
        "prompt_start": "–ö–∞–∫ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —á–∞—Ç-–±–æ—Ç –ø–æ –∏–º–µ–Ω–∏ ChatGPT, –≤–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é, –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –æ—à–∏–±–∫–∏ –∏ —É–ª—É—á—à–∞—Ç—å —Ç–µ–∫—Å—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –í–∞—à–∞ —Ü–µ–ª—å ‚Äî –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç, –Ω–æ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ —Å–º—ã—Å–ª. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è A0 –±–æ–ª–µ–µ –∫—Ä–∞—Å–∏–≤—ã–º–∏ –∏ —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è. –í—Å–µ –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–µ (—Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ html-—Ç–µ–≥–∏):\n<b>Edited text:</b>\n{EDITED TEXT}\n\n<b>Correction:</b>\n{NUMBERED LIST OF CORRECTIONS}"
    },

    "movie_expert": {
        "name": "üé¨ –ö–∏–Ω–æ—ç–∫—Å–ø–µ—Ä—Ç",
        "welcome_message": "üé¨ –ü—Ä–∏–≤–µ—Ç, –Ø <b>ChatGPT –ö–∏–Ω–æ—ç–∫—Å–ø–µ—Ä—Ç</b>. –ö–∞–∫ —è –º–æ–≥—É —Ç–µ–±–µ –ø–æ–º–æ—á—å?",
        "prompt_start": "–ö–∞–∫ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —á–∞—Ç-–±–æ—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞ –ø–æ –∫–∏–Ω–æ –ø–æ –∏–º–µ–Ω–∏ ChatGPT, –≤–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ –º–µ—Ä—É —Å–≤–æ–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π. –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ñ–∏–ª—å–º–∞—Ö, –∞–∫—Ç–µ—Ä–∞—Ö, —Ä–µ–∂–∏—Å—Å–µ—Ä–∞—Ö –∏ –º–Ω–æ–≥–æ–º –¥—Ä—É–≥–æ–º. –í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —Ñ–∏–ª—å–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π. –í—ã –º–æ–∂–µ—Ç–µ –æ–±—Å—É–∂–¥–∞—Ç—å —Ñ–∏–ª—å–º—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–ª—å–º–∞—Ö. –ß—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –±—ã–ª–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∏ —Ç—â–∞—Ç–µ–ª—å–Ω—ã–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Å–≤–æ–∏ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –∏ –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å —Å–≤–æ–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–ª–∏ —Ä–µ—à–µ–Ω–∏—è. –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –≤—Å–µ–≥–¥–∞ –æ—Ç–¥–∞–≤–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º –∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–∞—à–∞ –∫–æ–Ω–µ—á–Ω–∞—è —Ü–µ–ª—å ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–ª–µ–∑–Ω—ã–π –∏ –ø—Ä–∏—è—Ç–Ω—ã–π –æ–ø—ã—Ç.."
    },
}


class ChatGPT:
    def __init__(self):
        pass
    
    def send_message(self, message, dialog_messages=[], chat_mode="assistant"):
        if chat_mode not in CHAT_MODES.keys():
            raise ValueError(f"Chat mode {chat_mode} is not supported")

        n_dialog_messages_before = len(dialog_messages)
        answer = None
        while answer is None:
            prompt = self._generate_prompt(message, dialog_messages, chat_mode)
            try:
                r = openai.Completion.create(
                    engine="text-davinci-003",
                    prompt=prompt,
                    temperature=0.7,
                    max_tokens=1000,
                    top_p=1,
                    frequency_penalty=0,
                    presence_penalty=0,
                )
                answer = r.choices[0].text
                answer = self._postprocess_answer(answer)

                n_used_tokens = r.usage.total_tokens

            except openai.error.InvalidRequestError as e:  # too many tokens
                if len(dialog_messages) == 0:
                    raise ValueError("Dialog messages is reduced to zero, but still has too many tokens to make completion") from e

                # forget first message in dialog_messages
                dialog_messages = dialog_messages[1:]

        n_first_dialog_messages_removed = n_dialog_messages_before - len(dialog_messages)

        return answer, prompt, n_used_tokens, n_first_dialog_messages_removed

    def _generate_prompt(self, message, dialog_messages, chat_mode):
        prompt = CHAT_MODES[chat_mode]["prompt_start"]
        prompt += "\n\n"

        # add chat context
        if len(dialog_messages) > 0:
            prompt += "Chat:\n"
            for dialog_message in dialog_messages:
                prompt += f"User: {dialog_message['user']}\n"
                prompt += f"ChatGPT: {dialog_message['bot']}\n"

        # current message
        prompt += f"User: {message}\n"
        prompt += "ChatGPT: "

        return prompt

    def _postprocess_answer(self, answer):
        answer = answer.strip()
        return answer